# Remember Me MCP API site configuration
# Generated by Ansible

{{ domain_name }} {
    # Enable compression
    encode gzip
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }
    
    # CORS configuration for API
    @cors_preflight {
        method OPTIONS
    }
    handle @cors_preflight {
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
            Access-Control-Max-Age "86400"
        }
        respond 204
    }
    
    # API proxy configuration
    handle /api/* {
        header {
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
            Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With"
        }
        
        reverse_proxy localhost:{{ remember_me_port }} {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # Health check
            health_uri /health
            health_interval 30s
            health_timeout 5s
            health_status 200
            
            # Load balancing settings
            lb_policy round_robin
            lb_try_duration 30s
            
            # Transport settings
            transport http {
                read_timeout 30s
                write_timeout 30s
                dial_timeout 5s
            }
        }
    }
    
    # Swagger UI
    handle /swagger/* {
        reverse_proxy localhost:{{ remember_me_port }} {
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Health check endpoint
    handle /health {
        respond "OK" 200
    }
    
    # Metrics endpoint (protected)
    handle /metrics {
        basicauth {
            admin {{ vault_admin_password | password_hash('bcrypt') }}
        }
        reverse_proxy localhost:{{ remember_me_port }}
    }
    
    # Default response for root
    handle / {
        respond "Remember Me MCP API Server" 200
    }
    
    # Catch-all 404
    handle {
        respond "Not Found" 404
    }
    
    # Logging
    log {
        output file /var/log/caddy/{{ domain_name }}.log
        format json
    }
}